import { globby } from 'globby'
import fs from 'fs/promises'
import matter from 'gray-matter'
import path from 'path'

const ROOT = process.cwd()
const POSTS_DIR = path.join(ROOT, 'content', 'posts')
const OUT = path.join(ROOT, 'app', 'blog', 'mdx-index.ts')

const files = await globby(['content/posts/*.mdx', 'content/posts/*.md'])

const items = []
for (const f of files) {
  const raw = await fs.readFile(path.join(ROOT, f), 'utf8')
  const fm = matter(raw)
  const slug = String(fm.data.slug || path.basename(f).replace(/\.(mdx?|md)$/, '')).trim()
  items.push({
    slug,
    title: fm.data.title ?? slug,
    date: new Date(fm.data.date ?? 0).toISOString(),
    tags: Array.isArray(fm.data.tags) ? fm.data.tags : [],
    // importパスは相対で固定
    importPath: '../' + f.replace(/^content\//, ''),
  })
}

// mdxモジュールの遅延importマップを出力
const code =
`// auto-generated by build-mdx-index.mjs
export const postsMeta = ${JSON.stringify(items, null, 2)} as const;

export const postsMap = {
${items.map(i => `  "${i.slug}": () => import("${i.importPath}")`).join(',\n')}
} as const;
`
await fs.mkdir(path.dirname(OUT), { recursive: true })
await fs.writeFile(OUT, code)
console.log('generated:', OUT, items.length)
