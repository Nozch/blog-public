import { globby } from 'globby'
import fs from 'fs/promises'
import matter from 'gray-matter'
import path from 'path'

const OUT_DIR_POSIX = 'src/app/blog'
const ROOT = process.cwd()
const OUT_DIR = path.join(ROOT, OUT_DIR_POSIX)
const OUT = path.join(OUT_DIR, 'mdx-index.ts')

function toImportPath(posixFilePath) {
	const rel = path.posix.relative(OUT_DIR_POSIX, posixFilePath)
	return rel.startsWith('.') ? rel : `./${rel}`
}

const POSTS_DIR = path.join(ROOT, 'content', 'posts')

const files = await globby(['content/posts/**/*.{md,mdx}'], { cwd: ROOT })

const items = []

for (const f of files) {
	const fPosix = f.replace(/\\/g, '/')
	const abs = path.join(ROOT, fPosix)
  const raw = await fs.readFile(abs, 'utf8')
  const fm = matter(raw)
	
	const base = path.basename(fPosix).replace(/\.(mdx?|md)$/i, '')
	const slug = String(fm.data.slug || base).trim()

  items.push({
    slug,
    title: fm.data.title ?? slug,
    date: new Date(fm.data.date ?? 0).toISOString(),
    tags: Array.isArray(fm.data.tags) ? fm.data.tags : [],
		importPath: toImportPath(fPosix)
  })
}

const metas = items.map(({ importPath, ...meta }) => meta)

// mdxモジュールの遅延importマップを出力
const code = `// auto-generated by build-mdx-index.mjs
export type PostMeta = { slug: string; title: string; date: string; tags: string[] };
export const postsMeta: PostMeta[] = ${JSON.stringify(metas, null, 2)};

export const postsMap: Record<string, () => Promise<any>> = {
${items.map(i => `  ${JSON.stringify(i.slug)}: () => import(${JSON.stringify(i.importPath)})`).join(',\n')} 
};
`
await fs.mkdir(OUT_DIR, { recursive: true })
await fs.writeFile(OUT, code, 'utf8')
console.log('generated:', OUT, items.length)
